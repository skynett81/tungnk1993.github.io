<html>
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
		
		<link rel="stylesheet" href="../css/main.css">

		<script src="https://code.jquery.com/jquery-3.1.1.min.js"
				integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
				crossorigin="anonymous">
		</script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://momentjs.com/downloads/moment.js"></script>
		<script src="http://momentjs.com/downloads/moment-timezone-with-data.js"></script>
	</head>

	<body>
		<div class="container">
			<div class="col-lg-12">
				<div class="row col-lg-12 text-center">
					<h2><span id="headline">Streaming schedule of X</span></h2>
					<h3>Timezone - <span id="timezone"></span> </h3>
				</div>


				<div class="row">
					<div id="chart"></div>
				</div>

				<div id="urlForm" class="row col-xs-offset-3">
					<div class="col-xs-12">
						<label class="form-control-label">Streamer URL</label>
					</div>

					<div class="col-xs-6">
						<input type="text" class="form-control" id ="stream_url">
					</div>
					<div class="col-xs-3">
						<button type="submit" class="btn btn-primary" id="submit">Submit</button>
					</div>

					<div class="col-xs-12" style="padding-top:10px">
						<small class="form-text text-muted">Example: https://www.twitch.tv/admiralbulldog</small>
					</div>

					<div class="col-xs-12">
						<span class="text-danger" id="error"></span>
					</div>
				</div>

			</div>
		</div>
		<script src="main.js"></script>

		<script>
			function process_data(videos_json_data) {
				var MIN_RECORD_TIME = 1800; // 30 mins = 1800 secs
				var user_tz = moment.tz.guess();

				var data = [];
				var labels = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

				for (var i = 1; i <= 7; i++)
				{
					var blank = new Array();
					for (var j = 0; j < 24; j++) blank.push(0);

					var h = {
						label: labels[i-1],
						values: blank
					}

					data.push(h);
				}
				
				//console.log(JSON.stringify(data));
				
				videos_json_data.forEach(function(item, index) {
					var record_length = item["length"];
					var record_time = item["recorded_at"];
					if (record_length > MIN_RECORD_TIME) {
						var start_time = moment.tz(record_time, user_tz);
						var sum = 0;
						while (sum <= record_length) {
							var current_time = start_time.add(3600, 's');
							sum += 3600;
							var isoWeekday = current_time.isoWeekday() - 1;
							var hour = current_time.hour();
							data[isoWeekday]['values'][hour]++;
						}
					}
				});
				
				//console.log(data);
				var labelsX = [ 
								"0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11",
								"12","13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"
								];

				update(data, labelsX);
			}

			function fetchData(stream_id) {
				var api = 'https://api.twitch.tv/kraken/channels/' + stream_id + 
							'/videos?limit=100&broadcast_type=archive&client_id=9z62jo70mxlukt3ec7dj9vhhvb0yna';

				$.ajax({
					url: api, 
					success: function(result){
						$("#headline").html("Streaming schedule of " + stream_id);
						$("#error").html("");
						console.log(result);
						console.log("Videos found", result["_total"]);
						var punch_data = process_data(result["videos"]);
					},
					error: function(xhr, status, error) {
						$("#error").html("Wrong URL format or channel name");
					}
				});
			}

			$(function() {
				$("#timezone").html(moment.tz.guess());
				$('#submit').click(function() {
					console.log("Click submit");
					var stream_url = $('#stream_url').val().trim();
					console.log(stream_url);
					if (stream_url[stream_url.length - 1] == '/') 
						stream_url = stream_url.substring(0, stream_url.length - 1);
					console.log(stream_url);
					var stream_id = stream_url.substring(stream_url.lastIndexOf("/") + 1);
					console.log(stream_id);

					var vods_data = fetchData(stream_id);
				});
			});
		</script>
	</body>

	<footer style="margin-top:100px">
		<div class="container">
				<p class="text-muted">Last updated on 24 Jan 2017.<br>
				Credit <a href="http://bl.ocks.org/kaezarrex/10122633">punch card visualization</a><br>
				Help from <a href="https://www.reddit.com/r/Twitch/comments/5pvsfi/made_a_simple_tool_to_find_out_what_a_streamers/">Reddit Thread</a>
			</p>
			</div>
	</footer>
</html>